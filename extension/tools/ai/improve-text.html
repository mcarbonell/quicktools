<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Improve Text</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; padding: 16px; background: #f5f5f5; }
        .alert { padding: 12px; border-radius: 8px; margin-bottom: 12px; }
        .alert-warning { background: #fff3cd; border: 1px solid #ffc107; }
        .alert-success { background: #d1e7dd; border: 1px solid #0f5132; }
        .d-none { display: none !important; }
        .form-label { display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px; }
        .form-control, .form-select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        textarea.form-control { resize: vertical; font-family: inherit; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-sm { padding: 4px 8px; font-size: 12px; }
        .btn-outline-danger { background: white; color: #dc3545; border: 1px solid #dc3545; }
        .btn-outline-secondary { background: white; color: #6c757d; border: 1px solid #6c757d; }
        .btn-outline-info { background: white; color: #0dcaf0; border: 1px solid #0dcaf0; }
        .mb-3 { margin-bottom: 12px; }
        .mt-3 { margin-top: 12px; }
        .d-flex { display: flex; }
        .justify-content-between { justify-content: space-between; }
        .align-items-center { align-items: center; }
        .input-group { display: flex; gap: 4px; }
        .input-group .form-control { flex: 1; }
        #improvedOutput { padding: 12px; background: white; border: 1px solid #ddd; border-radius: 4px; min-height: 100px; }
    </style>
</head>
<body>
    <div id="apiKeySetup" class="alert alert-warning">
        <h5 style="margin-bottom: 8px;">‚öôÔ∏è Setup</h5>
        <p style="margin-bottom: 8px; font-size: 13px;">Get free API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></p>
        <div class="input-group">
            <input type="password" id="apiKeyInput" class="form-control" placeholder="AIzaSy...">
            <button class="btn btn-primary" id="saveKeyBtn">üíæ Save</button>
        </div>
    </div>

    <div id="apiKeyManage" class="alert alert-success d-none">
        <div class="d-flex justify-content-between align-items-center">
            <span style="font-size: 13px;">‚úÖ API Key configured</span>
            <button class="btn btn-sm btn-outline-danger" id="removeKeyBtn">üóëÔ∏è</button>
        </div>
    </div>

    <div id="toolSection" class="d-none">
        <div class="mb-3">
            <label class="form-label">Text to improve:</label>
            <textarea id="inputText" class="form-control" rows="6" placeholder="Paste your text here..."></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Mode:</label>
            <select id="modeSelect" class="form-select">
                <option value="grammar" selected>Fix Grammar & Spelling</option>
                <option value="clarity">Improve Clarity</option>
                <option value="professional">Make Professional</option>
                <option value="casual">Make Casual</option>
                <option value="concise">Make Concise</option>
            </select>
        </div>

        <button class="btn btn-primary" id="improveBtn" style="width: 100%;">‚ú® Improve Text</button>

        <div id="resultSection" class="mt-3 d-none">
            <label class="form-label">Improved text:</label>
            <div id="improvedOutput"></div>
            <div class="mt-3" style="display: flex; gap: 8px;">
                <button class="btn btn-sm btn-outline-secondary" id="copyBtn">üìã Copy</button>
                <button class="btn btn-sm btn-outline-info" id="downloadBtn">üíæ Download</button>
            </div>
        </div>
    </div>

    <script src="../../shared/gemini-api.js"></script>
    <script src="../../shared/improve-text-ui.js"></script>
    <script src="chat-ai-storage.js"></script>
    <script>
        let improveTextUI;

        document.addEventListener('DOMContentLoaded', async () => {
            improveTextUI = new ImproveTextUI({
                storage: ChromeGeminiStorage,
                translations: {}
            });
            await improveTextUI.init();
        });

        document.getElementById('saveKeyBtn').onclick = async () => {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) return alert('‚ùå Enter API key');

            const btn = document.getElementById('saveKeyBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Validating...';

            try {
                const success = await improveTextUI.saveApiKey(apiKey);
                if (success) alert('‚úÖ Saved');
                else alert('‚ùå Invalid key');
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = 'üíæ Save';
            }
        };

        document.getElementById('removeKeyBtn').onclick = () => {
            if (confirm('Remove API key?')) improveTextUI.removeApiKey();
        };

        document.getElementById('improveBtn').onclick = async () => {
            const text = document.getElementById('inputText').value;
            const mode = document.getElementById('modeSelect').value;
            const btn = document.getElementById('improveBtn');

            if (!text.trim()) return alert('‚ùå Enter text');

            btn.disabled = true;
            btn.textContent = '‚è≥ Improving...';

            try {
                const improved = await improveTextUI.improve(text, mode);
                const formatted = improveTextUI.formatText(improved);
                document.getElementById('improvedOutput').innerHTML = formatted;
                document.getElementById('resultSection').classList.remove('d-none');
            } catch (error) {
                alert(`‚ùå Error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ú® Improve Text';
            }
        };

        document.getElementById('copyBtn').onclick = () => {
            const text = document.getElementById('improvedOutput').innerText;
            navigator.clipboard.writeText(text).then(() => alert('‚úÖ Copied'));
        };

        document.getElementById('downloadBtn').onclick = () => {
            const text = document.getElementById('improvedOutput').innerText;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `improved-text-${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        };
    </script>
</body>
</html>
