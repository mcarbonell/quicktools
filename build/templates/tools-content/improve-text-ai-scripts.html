<script src="/js/lib/gemini-api.js"></script>
<script src="/js/lib/improve-text-ui.js"></script>
<script>
    let improveTextUI;

    window.addEventListener('DOMContentLoaded', async () => {
        improveTextUI = new ImproveTextUI({
            storage: GeminiStorage,
            translations: window.toolTranslations
        });
        await improveTextUI.init();
    });

    async function saveApiKey() {
        const apiKey = document.getElementById('apiKeyInput').value.trim();
        if (!apiKey) return alert('âŒ Please enter an API key');

        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'â³ Validating...';

        try {
            const success = await improveTextUI.saveApiKey(apiKey);
            if (success) alert('âœ… API Key saved successfully');
            else alert('âŒ Invalid API Key');
        } catch (error) {
            alert(`âŒ Error: ${error.message}`);
        } finally {
            btn.disabled = false;
            btn.textContent = 'ðŸ’¾ Save';
        }
    }

    function removeApiKey() {
        if (confirm('Remove API key?')) improveTextUI.removeApiKey();
    }

    async function improveText() {
        const text = document.getElementById('inputText').value;
        const mode = document.getElementById('modeSelect').value;
        const btn = document.getElementById('improveBtn');

        if (!text.trim()) return alert('âŒ Please enter text to improve');

        btn.disabled = true;
        btn.textContent = 'â³ Improving...';

        try {
            const improved = await improveTextUI.improve(text, mode);
            const formatted = improveTextUI.formatText(improved);
            document.getElementById('improvedOutput').innerHTML = formatted;
            document.getElementById('resultSection').classList.remove('d-none');
        } catch (error) {
            alert(`âŒ Error: ${error.message}`);
        } finally {
            btn.disabled = false;
            btn.textContent = 'âœ¨ Improve Text';
        }
    }

    function copyResult() {
        const text = document.getElementById('improvedOutput').innerText;
        navigator.clipboard.writeText(text).then(() => alert('âœ… Copied to clipboard'));
    }

    function downloadResult() {
        const text = document.getElementById('improvedOutput').innerText;
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `improved-text-${new Date().toISOString().slice(0,10)}.txt`;
        a.click();
        URL.revokeObjectURL(url);
    }
</script>
