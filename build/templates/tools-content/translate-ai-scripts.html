<script src="/js/lib/chrome-ai-apis.js"></script>
<script src="/js/lib/gemini-api.js"></script>
<script src="/js/lib/hybrid-ai.js"></script>
<script>
    let ai;
    let sourceLang = 'en';

    window.addEventListener('DOMContentLoaded', async () => {
        ai = new HybridAI();
        await ai.init();
        updateServiceStatus();
        
        const userLang = navigator.language.split('-')[0] || 'en';
        document.getElementById('targetLangSelect').value = userLang;
    });

    function updateServiceStatus() {
        const statusEl = document.getElementById('statusText');
        const configureBtn = document.getElementById('configureBtn');
        
        if (ai.hasChromeAI) {
            statusEl.textContent = 'ðŸ  Using Chrome Local AI (Free, Private)';
            statusEl.parentElement.parentElement.className = 'alert alert-success';
        } else if (ai.hasGeminiAPI) {
            statusEl.textContent = 'â˜ï¸ Using Gemini Cloud API';
            statusEl.parentElement.parentElement.className = 'alert alert-info';
        } else {
            statusEl.textContent = 'âš ï¸ No AI service available';
            statusEl.parentElement.parentElement.className = 'alert alert-warning';
            configureBtn.classList.remove('d-none');
        }
    }

    function showApiKeySetup() {
        document.getElementById('apiKeySetup').classList.remove('d-none');
    }

    async function saveApiKey() {
        const apiKey = document.getElementById('apiKeyInput').value.trim();
        if (!apiKey) return alert('âŒ Please enter an API key');

        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'â³ Validating...';

        try {
            localStorage.setItem('gemini_api_key', apiKey);
            await ai.init();
            updateServiceStatus();
            document.getElementById('apiKeySetup').classList.add('d-none');
            alert('âœ… API Key saved successfully');
        } catch (error) {
            alert(`âŒ Error: ${error.message}`);
        } finally {
            btn.disabled = false;
            btn.textContent = 'ðŸ’¾ Save';
        }
    }

    async function detectLanguage() {
        const text = document.getElementById('inputText').value;
        if (!text.trim()) return alert('âŒ Please enter text first');

        const span = document.getElementById('detectedLang');
        span.textContent = 'â³ Detecting...';

        try {
            const result = await ai.detectLanguage(text);
            sourceLang = result.language;
            const langNames = { en: 'English', es: 'Spanish', fr: 'French', de: 'German', it: 'Italian', pt: 'Portuguese', ja: 'Japanese', zh: 'Chinese', ru: 'Russian', ar: 'Arabic' };
            span.textContent = `Detected: ${langNames[sourceLang] || sourceLang}`;
        } catch (error) {
            span.textContent = 'âŒ Detection failed';
        }
    }

    async function translateText() {
        const text = document.getElementById('inputText').value;
        const targetLang = document.getElementById('targetLangSelect').value;
        const btn = document.getElementById('translateBtn');
        const outputEl = document.getElementById('translationOutput');

        if (!text.trim()) return alert('âŒ Please enter text to translate');

        btn.disabled = true;
        btn.textContent = 'â³ Translating...';
        outputEl.textContent = '';

        try {
            const translation = await ai.translate(text, sourceLang, targetLang);
            outputEl.textContent = translation;
            document.getElementById('resultActions').classList.remove('d-none');
        } catch (error) {
            alert(`âŒ Error: ${error.message}`);
        } finally {
            btn.disabled = false;
            btn.textContent = 'ðŸŒ Translate';
        }
    }

    function copyResult() {
        const text = document.getElementById('translationOutput').innerText;
        navigator.clipboard.writeText(text).then(() => alert('âœ… Copied to clipboard'));
    }

    function downloadResult() {
        const text = document.getElementById('translationOutput').innerText;
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `translation-${new Date().toISOString().slice(0,10)}.txt`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function swapLanguages() {
        const input = document.getElementById('inputText');
        const output = document.getElementById('translationOutput');
        const temp = input.value;
        input.value = output.innerText;
        output.innerHTML = '';
        document.getElementById('resultActions').classList.add('d-none');
    }
</script>
